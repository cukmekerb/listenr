<!doctype html>
<html>

<head>
    <title>Add your podcast to listenr</title>
    <!--metatags-->
    <link rel="manifest" href="manifest.json">
    <link rel="shortcut icon" href="icon-192.png">
    <meta charset="UTF-8">
    <meta name="description" content="The simplest podcatcher of them all">
    <meta name="image" content="icon-512.png">
    <meta itemprop="name" content="Listenr">
    <meta itemprop="description" content="The simplest podcatcher of them all">
    <meta itemprop="image" content="icon-512.png">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Listenr">
    <meta name="twitter:description" content="The simplest podcatcher of them all">
    <meta name="twitter:image:src" content="icon-512.png">
    <meta name="og:title" content="Listenr">
    <meta name="og:description" content="The simplest podcatcher of them all">
    <meta name="og:image" content="icon-512.png">
    <meta name="og:url" content="https://listenr.gq/">
    <meta name="og:site_name" content="Listenr">
    <meta name="og:locale" content="en_US">
    <meta name="og:type" content="website">
    <link rel="apple-touch-icon" href="apple-touch-icon.png" rel="preload">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!--no more metatags-->
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@beta/dist/js.cookie.min.js"></script>
    <link rel="stylesheet" href="view.css">
    <link rel="stylesheet" href="podcasters.css">
    <link href="http://fonts.cdnfonts.com/css/dejavu-sans" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/keymaster/1.6.1/keymaster.js"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" crossorigin="anonymous">
    <meta name="viewport" content="width=device-width, initial-scale=1, height=device-height" />
    <script>
        var feedurl;
        function htmltotext(html) {
            document.getElementById("texttester").innerHTML = html;
            var b = document.getElementById("texttester").innerText || document.getElementById("texttester").textContent;
            return b;
        }
        function validurl(str) {
            var pattern = new RegExp('^(https?:\\/\\/)?' +
                '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|' +
                '((\\d{1,3}\\.){3}\\d{1,3}))' +
                '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*' +
                '(\\?[;&a-z\\d%_.~+=-]*)?' +
                '(\\#[-a-z\\d_]*)?$', 'i');
            return !!pattern.test(str);
        }
        function check_show_db() {
            var link = document.getElementById("rss_url").value;
            feedurl = link;
            document.getElementById("output").classList.add("hidden")
            var goodhtml = `<i class="far fa-check-circle"></i> your show is in the database`;
            if (validurl(link)) {
                document.getElementById("error").classList.add("hidden");
                document.getElementById("shortlinkform").classList.add("hidden");
                document.getElementById("working").classList.remove("hidden");
                fetch("https://script.google.com/macros/s/AKfycby45awRekYOvIpe6ZFN_C5llswyiDGMnCwEoD9Dje_hQ1AqTnQ/exec?url=" + encodeURIComponent(link))
                    .then(a => a.json())
                    .then(result => {
                        if (result.rows[0] != null) {
                            document.getElementById("working").classList.add("hidden")
                            document.getElementById("output").classList.remove("hidden");
                            var ephtml = document.getElementById("show").innerHTML;
                            ephtml = ephtml.replace(/\$\$\%\%TOTITLE\%\%/gi, result.rows[0][0]);
                            ephtml = ephtml.replace(/\$\$\%\%DESK\%\%/gi, htmltotext(result.rows[0][1]).slice(0, 100) + "...");
                            ephtml = ephtml.replace(/\$\$PDI\%\%/gi, result.rows[0][2])
                            document.getElementById("show").innerHTML = ephtml;
                            document.getElementById("is_in_db").innerHTML = goodhtml;
                            setupshortlinkform(result.rows[0][0]);
                        }
                        else {
                            fetch("https://rss-to-json-convert.herokuapp.com/" + encodeURIComponent(link))
                                .then(a => a.json())
                                .then(feed => {
                                    document.getElementById("working").classList.add("hidden")
                                    var ephtml = document.getElementById("show").innerHTML;
                                    ephtml = ephtml.replace(/\$\$\%\%TOTITLE\%\%/gi, feed.title);
                                    ephtml = ephtml.replace(/\$\$\%\%DESK\%\%/gi, htmltotext(feed.description).slice(0, 100) + "...");
                                    ephtml = ephtml.replace(/\$\$PDI\%\%/gi, feed.image)
                                    document.getElementById("show").innerHTML = ephtml;
                                    document.getElementById("output").classList.remove("hidden");
                                    document.getElementById("is_in_db").innerHTML = "Adding your show to the database...";
                                    fetch("https://script.google.com/macros/s/AKfycbyT6aaorLO5aBeRl1YQH44kAlmtfTGvrQqrYcZXrQigbbosJalz/exec?name=" + encodeURIComponent(feed.title) + "&description=" + encodeURIComponent(feed.description) + "&image=" + encodeURIComponent(feed.image) + "&url=" + encodeURIComponent(link))
                                        .then(() => {
                                            document.getElementById("is_in_db").innerHTML = goodhtml;
                                            setupshortlinkform(feed.title);
                                        });
                                });
                        }

                    });
            }
            else {
                document.getElementById("error").innerHTML = "Invalid feed URL";
                document.getElementById("error").classList.remove("hidden");
            }
        }

        function checksearch(data) {
            if (data.keyCode == 13) {
                check_show_db();
            }
        }
        function camelize(str) {
            return str.replace(/(?:^\w|[A-Z]|\b\w|\s+)/g, function (match, index) {
                if (+match === 0) return "";
                return match.toUpperCase();
            });
        }
        function setupshortlinkform(title) {
            title = title.slice(0, 35);
            if (title.toUpperCase().startsWith("THE")) {
                title = title.replace(/the\s+/i, "");
            }
            title = title.replace(/\'|\"|\:|\`|\{|\/|\\|\||\.|\,/gi,"")
            title = camelize(title);
            document.getElementById("shortlinkinput").value = title;
            adjustwidth();
            document.getElementById("shortlinkform").scrollIntoView();
            document.getElementById("shortlinkform").classList.remove("hidden");
        }
        function adjustwidth() {
            if (document.getElementById("shortlinkinput").value.length > 7) {
                document.getElementById("width-machine").innerHTML = document.getElementById("shortlinkinput").value + "AAAA"
            }
            else {
                document.getElementById("width-machine").innerHTML = "aaaaaaaaaaaa";
            }
        }
        function checkshortlinksearch(data) {
            if (data.keyCode == 13) {
                makeshortlink();
            }
        }
        function makeshortlink() {
            if (document.getElementById("shortlinkinput").value != "" && document.getElementById("shortlinkinput").value) {
                document.getElementById("shortlinkinput").value = document.getElementById("shortlinkinput").value.replace(/\s+/g,"");
                adjustwidth();
                document.getElementById("shortlinkmade").classList.add("subbed");
                document.getElementById("shortlinkmade").classList.remove("notsubbed");
                var slashtag = document.getElementById("shortlinkinput").value;
                document.getElementById("shortlinkmade").classList.remove("hidden");
                document.getElementById("shortlinkmade").innerHTML = "working...";
                fetch(`https://script.google.com/macros/s/AKfycbyV5KBmG6g87GYTYcpu7YRIUAAdqXhEWD4a0hZrxLeFxH_KjlUAiR5Log/exec?url=${feedurl}&slashtag=${slashtag}`)
                    .then(a => a.json())
                    .then(result => {
                        if (!result.error) {
                            document.getElementById("shortlinkmade").innerHTML = `
                            Your shorlink is public at <a href="https://lstnr.gq/${result.shortlink_path}" target="_blank">lstnr.gq/${result.shortlink_path}</a>
                            `
                        }
                        else {
                            document.getElementById("shortlinkmade").classList.remove("subbed");
                            document.getElementById("shortlinkmade").classList.add("notsubbed");
                            document.getElementById("shortlinkmade").innerHTML = result.error;
                        }
                    })
            }
        }
    </script>
</head>

<body onload="adjustwidth(); window.scrollTo(0, 0);">
    <h1 id="signup">Add your show to <img src="listenr-logo.png"
            style="display: inline-block; margin-top: -10px; vertical-align: middle; cursor: pointer;" alt="listenr" onclick="location='/'"></h1>

    <p style="width: 100%; text-align: center; font-family:sans-serif; font-size: 20px; margin-top: -20px;">set up your own custom url</p>
    <div class="center">
        <input id="rss_url" placeholder="Enter your RSS URL" onkeypress="checksearch(event)" autocomplete="off"
            type="text">
        <br>
        <div onclick="check_show_db()" class="openbutton blue center"><span
                style="vertical-align: middle; display: inline-block; line-height: 50px;">Add Show</span></div>
        <br>
        <span class="center subbed hidden" id="working">Working (this may take a while)...</span>
        <br>
        <span class="center notsubbed hidden" id="error"></span>
        <div id="output" class="center hidden">
            <div id="show" class="episode show">
                <img src="$$PDI%%" class="showim" draggable="false">

                <h1 class="episode_title" style="display: inline;" id="title_$$i%%"> $$%%TOTITLE%%</h1><br>
                <div id="desc_$$i%%">$$%%DESK%%</div>
            </div>
            <span id="is_in_db" class="subbed">
                <i class="far fa-check-circle"></i> your show is in the database
            </span>
            <div id="shortlinkform" class="hidden">
                <h2>Make a shortlink for your podcast</h2>
                <span id="sl_span">lstnr.gq/</span>
                <span class="input-wrap">
                    <span class="width-machine" aria-hidden="true" id="width-machine">aaaaaaaaaaaa</span>
                    <input id="shortlinkinput" placeholder="ShowTitle" onkeydown="adjustwidth()" onkeyup="adjustwidth()"
                        maxlength="35" onkeypress="checkshortlinksearch(event)">
                </span>
                <br><br>
                <div onclick="makeshortlink()" class="openbutton blue center"><span
                        style="vertical-align: middle; display: inline-block; line-height: 50px;">Make Shortlink</span>
                </div>
                <br>
                <span class="center subbed hidden" id="shortlinkmade">Your shourlink is at</span>
            </div>
        </div>
    </div>
    <div id="texttester" style="display: none; visibility: hidden;"></div>
    <!-- addthis garbage:-->
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5f0cba4ead99598d"></script>
</body>

</html>