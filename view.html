<!doctype html>
<html>

<head>
    <title>listenr</title>
    <!--metatags-->
    <link rel="manifest" href="manifest.json">
    <link rel="shortcut icon" href="icon-192.png">
    <meta charset="UTF-8">
    <meta name="og:locale" content="en_US">
    <meta name="og:type" content="website">
    <link rel="apple-touch-icon" href="apple-touch-icon.png" rel="preload">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!--no more metatags-->
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@beta/dist/js.cookie.min.js"></script>
    <link rel="stylesheet" href="view.css">
    <link href="http://fonts.cdnfonts.com/css/dejavu-sans" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/gh/cukmekerb/keymaster/keymaster.min.js"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/gh/mozilla/localForage@master/dist/localforage.js"></script>
    <script src="common.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/autolink-js/autolink-min.js"></script>
    <meta name="viewport"
        content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no, height=device-height, target-densitydpi=device-dpi" />
    <script>
        var user = {
            subscribed: []
        };
        var exp = {
            expires: 100000
        };
        var castdesk;
        var episodes = [];
        var whathasbeenloaded = {
            items: []
        };
        var feedurl;
        let root = document.documentElement;
        var defaultephtml;
        var playingep;
        var lasttime;
        var intervalaler = false;
        function safe_decode(uri) {
            if (!uri) {
                return uri
            }
            try {
                return decodeURIComponent(uri.replace(/%(?![0-9][0-9a-fA-F]+)/gi, '%25'))
            }
            catch (err) {
                return decodeURIComponent(uri)
            }
        }
        key("space", () => {
            toggleplaypause();
        });
        key("right", () => {
            playingep.currentTime += 15;
        });
        key("left", () => {
            playingep.currentTime -= 15;
        });
        String.prototype.toHHMMSS = function () {
            var sec_num = parseInt(this, 10);
            var hours = Math.floor(sec_num / 3600);
            var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
            var seconds = sec_num - (hours * 3600) - (minutes * 60);
            if (hours < 10) {
                hours = "0" + hours;
            }
            if (minutes < 10) {
                minutes = "0" + minutes;
            }
            if (seconds < 10) {
                seconds = "0" + seconds;
            }
            if (Number(hours) < 1) {
                return minutes + ':' + seconds;
            }
            return hours + ':' + minutes + ':' + seconds;
        }

        function scrollelement(id, target, seconds, rate) {
            if (document.getElementById(id).scrollTop - target > 1) {
                var frames = seconds * rate;
                var diff = (document.getElementById(id).scrollTop - target) / frames;
                for (var i = 0; i < frames; i++) {
                    setTimeout(function () {
                        document.getElementById(id).scrollTop -= diff;
                    }, i * 1000 / rate);
                }
            }
        }
        function makedescsize() {
            var deskslice = 300;
            if (document.documentElement.clientWidth <= 1000) {
                deskslice = -41523 / 400000000 * document.documentElement.clientWidth * document.documentElement.clientWidth + 3082188903 / 5000000000 * document.documentElement.clientWidth - 1495339502341 / 10000000000
            }
            return deskslice;
        }
        async function init() {
            user = await getuser();
            if ("serviceWorker" in navigator) {
                navigator.serviceWorker
                    .register("cache.js")
                    .then(function () { console.log("service worker registered"); });
            }
            feedurl = String(window.location).split("?AetBh69feedbH=")[1];
            if (String(window.location).includes("?AetBh69feedbH=") && feedurl.length != 0 && feedurl != null && validurl(window.atob(feedurl))) {
                feedurl = window.atob(feedurl);
                getfeed(feedurl);
                document.getElementById("subbutton").setAttribute("onclick", "subscribe()");
                if (user.subscribed.indexOf(user.subscribed.find(a => safe_decode(a.url) == feedurl)) > -1) {
                    document.getElementById("subbutton").innerHTML = "Subscribed   <i class='fas fa-check'></i>";
                    document.getElementById("subbutton").setAttribute("onclick", "un" + document.getElementById("subbutton").getAttribute("onclick"));
                    document.getElementById("subbutton").classList.replace("subscribe-u", "subscribe-s");
                }
                user.lastvisited = feedurl;
                savecookies();
            } else if (user.lastvisited != null && user.lastvisited.length != 0) {
                feedurl = user.lastvisited;
                getfeed(feedurl);
                document.getElementById("subbutton").setAttribute("onclick", "subscribe('" + feedurl + "')");
                
                if (user.subscribed.indexOf(user.subscribed.find(a => safe_decode(a.url) == feedurl)) > -1) {
                    document.getElementById("subbutton").innerHTML = "Subscribed   <i class='fas fa-check'></i>";
                    document.getElementById("subbutton").setAttribute("onclick", "un" + document.getElementById("subbutton").getAttribute("onclick"));
                    document.getElementById("subbutton").classList.replace("subscribe-u", "subscribe-s");
                }
                
            } else {
                window.location = "yours.html";
            }
        }

        function getfeed(link) {
            fetch("https://lstnr.gq/.netlify/functions/rss-to-json?items=10&url=" + encodeURIComponent(link))
                .then(a => a.json())
                .then(feed => {
                    document.getElementById("title").innerHTML = feed.title;
                    document.title = feed.title + " - listenr";
                    defaultephtml = document.getElementsByClassName("episode")[0].outerHTML;
                    document.getElementById("image").src = feed.image;
                    if (user.subscribed.find(a => a.url == link) != null) {
                        user.subscribed[user.subscribed.findIndex(a => safe_decode(a.url) == link)].image = encodeURIComponent(document.getElementById("image").src);
                        console.log("updating image")
                        user.subscribed[user.subscribed.findIndex(a => safe_decode(a.url) == link)].desc = encodeURIComponent(feed.description);
                        user.subscribed[user.subscribed.findIndex(a => safe_decode(a.url) == link)].title = encodeURIComponent(feed.title);
                        savecookies();
                    }
                    if (feed.items[0].itunes_author != null) {
                        document.getElementById("author_name").innerHTML = feed.items[0].itunes_author;
                    }
                    document.getElementById("description").innerHTML = htmltotext(String(feed.description).slice(0, makedescsize()));
                    castdesk = feed.description;
                    if (String(document.getElementById("description").innerHTML).length < castdesk.length) {
                        document.getElementById("description").innerHTML += "... <i onclick='longpoddesk()' class='shortlong'>more</i>";
                    }
                    filleps(feed)
                    whathasbeenloaded = feed;
                    return feed;
                })
                .then(feed => {
                    fetch("https://script.google.com/macros/s/AKfycby45awRekYOvIpe6ZFN_C5llswyiDGMnCwEoD9Dje_hQ1AqTnQ/exec?url=" + encodeURIComponent(link))
                        .then(a => a.json())
                        .then(result => {
                            if (result.rows[0] == null) {
                                fetch("https://script.google.com/macros/s/AKfycbyT6aaorLO5aBeRl1YQH44kAlmtfTGvrQqrYcZXrQigbbosJalz/exec?url=" + encodeURIComponent(link))
                            }
                        });
                });
        }
        function filleps(feed) {
            var episodehtml;
            var iteml = whathasbeenloaded.items.length || 0;
            console.log(iteml)
            if (document.getElementById("loadmore")) {
                document.getElementById("loadmore").outerHTML = "";
            }
            for (i in feed.items) {
                ii = iteml + Number(i);
                episodehtml = String(document.getElementsByClassName("episode")[0].outerHTML).replace(/\$\$\i\%\%/gi, ii);
                episodehtml = episodehtml.replace("display:none", "");
                if (String(feed.items[i].title).length > 30) {
                    episodehtml = episodehtml.replace("$$%%TOTITLE%%", String(feed.items[i].title).slice(0, 31) + "...");
                } else {
                    episodehtml = episodehtml.replace("$$%%TOTITLE%%", String(feed.items[i].title));
                }
                episodehtml = episodehtml.replace("$$%%DESK%%", htmltotext(String(feed.items[i].description).slice(0, 250)) + "... <i class='shortlong' onclick='showmore(" + ii + ")'>more</i>");
                episodehtml = episodehtml.replace(/<br>/gi, "\n");
                document.getElementById("episodes").innerHTML += "<br>" + episodehtml;
                episodes.push({
                    title: feed.items[i].title,
                    desc: String(feed.items[i].description).replace(/\n/gi, "<br>"),
                    url: feed.items[i].enclosures[0].url,
                    pubdate: new Date(feed.items[i].published).toLocaleString()
                });

            }
            document.getElementById("episodes").innerHTML += "<div id='loadmore' onclick='loadmore()'>Load more</div>";
            document.getElementById("episodes").classList.remove("hidden");
            setTimeout(() => {
                document.getElementById("noscrolly").classList.remove("hidden");
                document.getElementById("loading").classList.add("hidden");
            }, 100)
        }
        function loadmore() {

            document.getElementById("loadmore").innerHTML = "<i style='text-align:center; margin-left:auto; margin-right:auto;'>Loading...</i>";
            fetch("https://lstnr.gq/.netlify/functions/rss-to-json?items=10&startfrom=" + whathasbeenloaded.items.length + "&url=" + encodeURIComponent(feedurl))
                .then(a => a.json())
                .then(feed => {
                    if (feed.items.length < 1) {
                        document.getElementById("loadmore").outerHTML = "<br><i style='text-align:center; margin-left:auto; margin-right:auto;'>No more episodes to load.</i>";
                        return
                    }
                    document.getElementById("loadmore").outerHTML="";
                    filleps(feed);
                })
            /*
            for (var i = b; i < 10 + b && i < feed.items.length; i++) {
                episodehtml = String(defaultephtml).replace(/\$\$\i\%\%/gi, i);
                if (String(feed.items[i].title).length > 30) {
                    episodehtml = episodehtml.replace("$$%%TOTITLE%%", String(feed.items[i].title).slice(0, 31) + "...");
                } else {
                    episodehtml = episodehtml.replace("$$%%TOTITLE%%", String(feed.items[i].title));
                }
                episodehtml = episodehtml.replace("$$%%DESK%%", htmltotext(String(feed.items[i].description).slice(0, 250)) + "... <i class='shortlong' onclick='showmore(" + i + ")'>more</i>");
                episodehtml = episodehtml.replace(/<br>/gi, "\n");
                document.getElementById("episodes").innerHTML += "<br>" + episodehtml;
                episodes.push({
                    title: feed.items[i].title,
                    desc: String(feed.items[i].description).replace(/\n/gi, "<br>"),
                    url: feed.items[i].enclosures[0].url,
                    pubdate: new Date(feed.items[i].published).toLocaleString()
                });
                if (i >= b + 9) {
                    document.getElementById("episodes").innerHTML += "<div id='loadmore' onclick='loadmore()'>Load more</div>";
                }
                if (i >= feed.items.length - 1) {
                    document.getElementById("episodes").innerHTML += "<br><i style='text-align:center; margin-left:auto; margin-right:auto;'>No more episodes to load.</i>";
                }
            }
            */
        }


        function longpoddesk() {
            document.getElementById("description").innerHTML = castdesk.autoLink(link_config) + "<br><i onclick='shortpoddesk()' class='shortlong'>less</i>";
            setTimeout(() => {
                
            }, 150)
        }

        function shortpoddesk() {
            document.getElementById("description").innerHTML = htmltotext(castdesk.slice(0, makedescsize())) + "... <i onclick='longpoddesk()' class='shortlong'>more</i>";
            scrollelement("desc_scroll", 0, 0.5, 60);
            setTimeout(() => {
                
            }, 200)
        }

        function showplay(i) {
            document.getElementById("playbutton-" + i).classList.add("showing");
        }

        function hideplay(i) {
            document.getElementById("playbutton-" + i).classList.remove("showing");
        }

        function playepisode(i) {
            if (playingep != null) {
                playingep.pause();
            }
            document.getElementById("nowplaying").innerHTML = episodes[i].title + " - " + document.getElementById("title").innerHTML;
            var textsize = testwidth(document.getElementById("nowplaying").innerHTML, "14px", "bold");
            var clipwidth = document.getElementById("nowplayingcont").clientWidth * 0.7;
            root.style.setProperty("--title-pos", (Math.abs(Math.round((document.getElementById("nowplayingcont").clientWidth - textsize) - clipwidth)) - (Math.abs(Math.round((document.getElementById("nowplayingcont").clientWidth - textsize) - clipwidth)) / 2) + 2) + "px");
            playingep = new Audio(episodes[i].url);
            playingep.preload = "auto";
            playingep.play();
            updateplayer();
            document.getElementById("player").classList.replace("hidingplayer", "nonhidingplayer");
            epplayed();
            playingep.onpause = eppaused;
            playingep.onplay = epplayed;
        }

        function updateplayer() {
            if (!intervalaler) {

                lasttime = playingep.currentTime;
                var endedtime = 0;
                setInterval(() => {
                    if (playingep.currentTime - lasttime < 0.15) {
                        document.getElementById("player_move").value = (playingep.currentTime / playingep.duration) * 100;
                        var d = "linear-gradient(90deg, rgb(84, 255, 78) " + document.getElementById("player_move").value + "%, rgba(182,182,182,1) " + document.getElementById("player_move").value + "%, rgba(182,182,182,1) 100%)";
                        root.style.setProperty("--slider-val", d);
                        if (playingep.ended && endedtime > 2) {
                            document.getElementById("player").classList.replace("nonhidingplayer", "hidingplayer");
                            playingep = null;
                        } else if (playingep.ended) {
                            endedtime += 0.1;
                            document.getElementById("play_pause").classList.replace("fa-pause-circle", "fa-play-circle");
                        } else {
                            endedtime = 0;
                        }
                    }
                    lasttime = playingep.currentTime;
                    document.getElementById("timeleft").innerHTML = String(playingep.currentTime).toHHMMSS();
                    document.getElementById("minustime").innerHTML = "-" + String(playingep.duration - playingep.currentTime).toHHMMSS();
                }, 100)
            }
        }

        function showmore(i) {
            document.getElementById("desc_" + i).innerHTML = episodes[i].desc.autoLink(link_config) + "<br><br><i>Published " + episodes[i].pubdate + "</i><br><br><i class='shortlong' onclick='showless(" + i + ")'>less</i><br>";
            document.getElementById("title_" + i).innerHTML = episodes[i].title;
        }

        function showless(i) {

            document.getElementById("desc_" + i).innerHTML = htmltotext(episodes[i].desc.replace(/<br>/gi, "\n").slice(0, 250)) + "... <i class='shortlong' onclick='showmore(" + i + ")'>more</i>";

            if (String(episodes[i].title).length < 30) {
                document.getElementById("title_" + i).innerHTML = episodes[i].title;
            } else {
                document.getElementById("title_" + i).innerHTML = episodes[i].title.slice(0, 30) + "...";
            }
        }

        function subscribe() {
            var url = feedurl;
            user.subscribed.splice(0, 0, {
                url: encodeURIComponent(url),
                desc: encodeURIComponent(castdesk),
                title: encodeURIComponent(String(document.title).replace("- listenr", "")),
                img: encodeURIComponent(document.getElementById("image").src)
            });
            setTimeout(function () {
                document.getElementById("subbutton").classList.replace("subscribe-u", "subscribe-s");
            }, 20);
            document.getElementById("subbutton").innerHTML = "Subscribed   <i class='fas fa-check'></i>";
            savecookies();
            document.getElementById("subbutton").setAttribute("onclick", "un" + document.getElementById("subbutton").getAttribute("onclick"))
        }

        function unsubscribe() {
            var url = feedurl;
            if (user.subscribed.find(a => safe_decode(a.url) == url) != null) {
                user.subscribed.splice(user.subscribed.indexOf(user.subscribed.find(a => safe_decode(a.url) == url)), 1);
            }
            setTimeout(function () {
                document.getElementById("subbutton").innerHTML = "Subscribe";
            }, 50);
            savecookies();
            document.getElementById("subbutton").classList.replace("subscribe-s", "subscribe-u");
            document.getElementById("subbutton").setAttribute("onclick", document.getElementById("subbutton").getAttribute("onclick").replace("un", ""))
        }

        function playermove() {
            var d = "linear-gradient(90deg, rgb(84, 255, 78) " + document.getElementById("player_move").value + "%, rgba(182,182,182,1) " + document.getElementById("player_move").value + "%, rgba(182,182,182,1) 100%)";
            root.style.setProperty("--slider-val", d);
            if (document.getElementById("player_move").value / 100 * playingep.duration != playingep.currentTime) {
                playingep.currentTime = document.getElementById("player_move").value / 100 * playingep.duration;
            }
        }

        function toggleplaypause() {
            if (playingep.src != null) {
                if (playingep.paused) {
                    epplayed();
                    playingep.play()
                } else {
                    eppaused();
                    playingep.pause();
                }
            }
        }
        function eppaused() {
            document.getElementById("play_pause").classList.replace("fa-pause-circle", "fa-play-circle");
        }
        function epplayed() {
            document.getElementById("play_pause").classList.replace("fa-play-circle", "fa-pause-circle");
        }

        function testwidth(text, size, weight) {
            document.getElementById("widthtester").innerHTML = text;
            document.getElementById("widthtester").style.fontSize = size;
            document.getElementById("widthtester").style.fontWeight = weight;
            return document.getElementById("widthtester").clientWidth;
        }
    </script>
</head>

<body onload="init()">
    <div id="navbar">
        <span id="logopan" onclick="window.location='index.html'">
            <img src="listenr-logo-scaled.png" height="70"
                style="display: inline-block; vertical-align: middle; margin-top: -15px;">
        </span>
        <span class="navigation" onclick="window.location='yours.html'">Your Podcasts</span> <span class="navigation"
            style="font-weight: 700; font-size: 19px; color: white;">View Show</span> <input name="AetBh69SERCH99bH"
            id="AetBh69SERCH99bH" placeholder="Search for a podcast..." onkeypress="csearch(event)" autocomplete="off"
            type="text">
        <span id="hidinput"><i style="margin-right: 5px;">or</i> <input placeholder="Add by RSS..."
                onkeypress="checkrss(event)" autocomplete="off" type="url" id="rssurl"></span>
    </div>
    <div id="mobilenav">
        <div class="burger" onclick="showmnav()"></div>

        <span id="logopan" onclick="window.location='index.html'">
            <img src="listenr-logo-scaled.png" height="60"
                style="display: inline-block; vertical-align: middle; margin-top: -20px;">
    </div>
    <div id="mobileside" class="leftside">
        <div class="burgerx" onclick="hidemnav()"><i class="fas fa-times"></i></div>
        <img src="listenr-logo-scaled.png" height="60"
            style="display: inline-block; vertical-align: middle; margin-top: -20px;">
        <br><br>
        <span class="navigation" onclick="window.location='yours.html'">Your Podcasts</span>
        <span class="navigation" style="font-weight: 700; font-size: 19px; color: white;">View Show</span>
        <input name="AetBh69SERCH99bH" id="AetBh69SERCH99bHm" placeholder="Search for a podcast..."
            onkeypress="csearch(event)" autocomplete="off" type="text">
        <input placeholder="Add by RSS..." onkeypress="checkrss(event)" autocomplete="off" type="url" id="rssurlm">
    </div>

    <div id="nav-space"></div>
    <p class="centererror" id="loading">Loading...</p>
    <div id="noscrolly" class="hidden flex">
                <div id="s600ptd">
                    <div id="output" class="flex">
                        <img id="image">
                        <span id="titlespan">
                            <div  id="desc_scroll">
                                <h1 id="title"></h1>
                                <span id="author_name"></span>
                                <p id="description"></p>
                                <div class="subscribe-u" id="subbutton">Subscribe</div>
                            </div>
                        </span>
                    </div>

                </div>
                <div id="episode_td">
                    <div id="episodes" class="scrollable hidden">
                        <div class="episode" style="display:none;">
                            <i class="fas fa-play-circle smallplaybutton" id="playbutton-$$i%%"
                                onclick="playepisode(Number('$$i%%'))"></i>
                            <h1 class="episode_title" style="display: inline;" id="title_$$i%%"> $$%%TOTITLE%%</h1>
                            <div id="desc_$$i%%">$$%%DESK%%</div>
                        </div>
                    </div>
                </div>
    </div>
    <div id="player" class="hidingplayer">
        <div id="progress_container"><span id="timeleft">00:00</span><input type="range" min="0" max="100" value="0"
                class="slider" id="player_move" oninput="playermove()"><span id="minustime">-00:00</span></div>
        <div id="player_controls">
            <i class="fas fa-undo mediabutton" id="back15" onclick="playingep.currentTime-=15"></i> <i
                class="fas fa-play-circle mediabutton" id="play_pause" onclick="toggleplaypause()"></i> <i
                class="fas fa-redo mediabutton" id="for15" onclick="playingep.currentTime+=15"></i>
        </div>
        <div id="nowplayingcont">
            <p id="nowplaying">A show</p>
        </div>
    </div>
    <div id="announcement" class="hidden">
      <i class="fas fa-times" onclick="hideannouncement()"></i>
      <h1 id="announcement_h1">
        What's New
      </h1>
      <ul id="announcement_ul">
      </ul>
    </div>
    <div id="widthtester"></div>
    <div id="texttester" style="display: none; visibility: hidden;"></div>
    
</body>

</html>
